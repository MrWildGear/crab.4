@echo off
REM Comprehensive anti-malware build script for EVE Log Reader
REM This script implements multiple strategies to reduce virus detection

echo ========================================
echo EVE Log Reader - Anti-Malware Build
echo ========================================
echo.

REM Check if virtual environment exists and activate it
if exist "..\.venv\Scripts\activate.bat" (
    echo Found virtual environment, activating...
    call "..\.venv\Scripts\activate.bat"
    echo Virtual environment activated: %VIRTUAL_ENV%
) else (
    echo No virtual environment found, using system Python
    echo Make sure PyInstaller is installed: pip install pyinstaller
)

echo.

REM Install/upgrade required packages
echo Installing/upgrading required packages...
python -m pip install --upgrade pip
python -m pip install --upgrade pyinstaller
echo.

REM Clean previous builds
echo Cleaning previous builds...
if exist "build" rmdir /s /q "build"
if exist "dist" rmdir /s /q "dist"
if exist "__pycache__" rmdir /s /q "__pycache__"
echo.

REM Create organized distribution structure first
echo Creating organized distribution structure...
mkdir "dist\CRAB Tracker"
echo.

REM Build with enhanced anti-malware settings directly to organized folder
echo Building executable with enhanced anti-malware optimizations...
echo Building directly to: dist\CRAB Tracker\
echo.

REM Use the enhanced spec file with custom distpath
pyinstaller --clean --distpath "dist\CRAB Tracker" EVE_Log_Reader_enhanced.spec

if %ERRORLEVEL% NEQ 0 (
    echo.
    echo ERROR: Build failed!
    echo.
    pause
    exit /b 1
)

echo.
echo ========================================
echo Build completed successfully!
echo ========================================
echo.

REM Copy configuration files to distribution folder
echo Copying configuration files...
copy "google_form_config.json" "dist\CRAB Tracker\"

REM Create README for distribution
echo CRAB Tracker - EVE Online Log Reader > "dist\CRAB Tracker\README.txt"
echo. >> "dist\CRAB Tracker\README.txt"
echo Installation: >> "dist\CRAB Tracker\README.txt"
echo 1. Extract all files to a folder >> "dist\CRAB Tracker\README.txt"
echo 2. Run EVE_Log_Reader_Enhanced.exe >> "dist\CRAB Tracker\README.txt"
echo 3. The app will create logs and data files automatically >> "dist\CRAB Tracker\README.txt"
echo. >> "dist\CRAB Tracker\README.txt"
echo Features: >> "dist\CRAB Tracker\README.txt"
echo - CONCORD Rogue Analysis Beacon tracking >> "dist\CRAB Tracker\README.txt"
echo - CRAB bounty monitoring >> "dist\CRAB Tracker\README.txt"
echo - Google Form integration >> "dist\CRAB Tracker\README.txt"
echo - Session data export >> "dist\CRAB Tracker\README.txt"

echo.
echo Distribution folder created: dist\CRAB Tracker\
echo.

REM Show file information
if exist "dist\CRAB Tracker\EVE_Log_Reader_Enhanced.exe" (
    echo Executable created: dist\CRAB Tracker\EVE_Log_Reader_Enhanced.exe
    
    REM Get file size
    for %%A in ("dist\CRAB Tracker\EVE_Log_Reader_Enhanced.exe") do set "size=%%~zA"
    set /a "size_mb=%size%/1024/1024"
    echo File size: %size_mb% MB
    
    REM Get file hash for verification
    echo.
    echo Calculating file hash for verification...
    powershell -Command "Get-FileHash 'dist\CRAB Tracker\EVE_Log_Reader_Enhanced.exe' -Algorithm SHA256 | Select-Object Hash, Algorithm | Format-Table -AutoSize"
    
    echo.
    echo ========================================
    echo Enhanced anti-malware optimizations applied:
    echo ========================================
    echo ✓ UPX compression enabled
    echo ✓ Aggressive library exclusions
    echo ✓ Enhanced file metadata
    echo ✓ Professional company branding
    echo ✓ Clean build environment
    echo ✓ Reduced file size
    echo.
    echo ========================================
    echo Additional anti-malware strategies:
    echo ========================================
    echo 1. Use ZIP instead of RAR for distribution
    echo 2. Upload to VirusTotal for analysis
    echo 3. Submit to Windows Defender for review
    echo 4. Use code signing certificate (if available)
    echo 5. Distribute through trusted channels
    echo.
    echo ========================================
    echo Build optimization complete!
    echo ========================================
    echo.
    echo The executable has been built with enhanced
    echo anti-malware optimizations.
    echo.
    echo IMPORTANT: For distribution, use ZIP format
echo instead of RAR to reduce detection.
echo.
echo ========================================
echo Distribution Ready!
echo ========================================
echo.
echo Your distribution package is ready in:
echo dist\CRAB Tracker\
echo.
echo To create a ZIP for distribution:
echo 1. Right-click on "CRAB Tracker" folder
echo 2. Select "Send to" ^> "Compressed (zipped) folder"
echo 3. Or use: powershell Compress-Archive "dist\CRAB Tracker" "CRAB_Tracker_v1.0.zip"
echo.
echo Distribution contents:
dir "dist\CRAB Tracker" /b
echo.
) else (
    echo ERROR: Executable not found in dist\CRAB Tracker folder!
)

echo.
pause
