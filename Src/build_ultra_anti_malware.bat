@echo off
REM Ultra-enhanced anti-malware build script for EVE Log Reader
REM This script implements maximum strategies to reduce virus detection across different antivirus systems

echo ========================================
echo EVE Log Reader - Ultra Anti-Malware Build
echo ========================================
echo.

REM Check if virtual environment exists and activate it
if exist "..\.venv\Scripts\activate.bat" (
    echo Found virtual environment, activating...
    call "..\.venv\Scripts\activate.bat"
    echo Virtual environment activated: %VIRTUAL_ENV%
) else (
    echo No virtual environment found, using system Python
    echo Make sure PyInstaller is installed: pip install pyinstaller
)

echo.

REM Install/upgrade required packages
echo Installing/upgrade required packages...
python -m pip install --upgrade pip
python -m pip install --upgrade pyinstaller
echo.

REM Clean previous builds completely
echo Cleaning previous builds completely...
if exist "build" rmdir /s /q "build"
if exist "dist" rmdir /s /q "dist"
if exist "__pycache__" rmdir /s /q "__pycache__"
if exist "*.spec" del "*.spec"
if exist "*.exe" del "*.exe"
echo.

REM Build with ultra-enhanced anti-malware settings
echo Building executable with ultra-enhanced anti-malware optimizations...
echo.

REM Use the ultra-enhanced spec file
pyinstaller --clean EVE_Log_Reader_ultra_enhanced.spec

if %ERRORLEVEL% NEQ 0 (
    echo.
    echo ERROR: Build failed!
    echo.
    pause
    exit /b 1
)

echo.
echo ========================================
echo Build completed successfully!
echo ========================================
echo.

REM Show file information
if exist "dist\EVE_Log_Reader_Ultra.exe" (
    echo Executable created: dist\EVE_Log_Reader_Ultra.exe
    
    REM Get file size
    for %%A in ("dist\EVE_Log_Reader_Ultra.exe") do set "size=%%~zA"
    set /a "size_mb=%size%/1024/1024"
    echo File size: %size_mb% MB
    
    REM Get file hash for verification
    echo.
    echo Calculating file hash for verification...
    powershell -Command "Get-FileHash 'dist\EVE_Log_Reader_Ultra.exe' -Algorithm SHA256 | Select-Object Hash, Algorithm | Format-Table -AutoSize"
    
    echo.
    echo ========================================
    echo Ultra-enhanced anti-malware optimizations applied:
    echo ========================================
    echo ✓ UPX compression enabled
    echo ✓ Ultra-aggressive library exclusions
    echo ✓ Maximum professional metadata
    echo ✓ Professional company branding (Inc.)
    echo ✓ Clean build environment
    echo ✓ Maximum file size reduction
    echo ✓ Enhanced file properties
    echo.
    echo ========================================
    echo Additional anti-malware strategies:
    echo ========================================
    echo 1. Use ZIP instead of RAR for distribution
    echo 2. Upload to VirusTotal for analysis
    echo 3. Submit to Windows Defender for review
    echo 4. Use code signing certificate (if available)
    echo 5. Distribute through trusted channels
    echo 6. Test with multiple antivirus systems
    echo 7. Submit false positives to vendors
    echo.
    echo ========================================
    echo Build optimization complete!
    echo ========================================
    echo.
    echo The executable has been built with ultra-enhanced
    echo anti-malware optimizations for maximum detection reduction.
    echo.
    echo IMPORTANT: For distribution, use ZIP format
    echo instead of RAR to reduce detection.
    echo.
    echo TIP: Test with multiple antivirus systems to
    echo ensure maximum compatibility.
    echo.
) else (
    echo ERROR: Executable not found in dist folder!
)

echo.
pause
